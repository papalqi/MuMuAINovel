# 断章 / “戒断”处理：续写对齐与 max_tokens

> 这里的“戒断/断章”泛指：章节生成中途停止、结尾半句、风格突然断裂、或内容明显缺失。

## 1) 典型原因（按概率从高到低）

1. **命中模型输出上限**：模型或渠道对输出 token 有硬上限，到了就截断。
2. **max_tokens 配置过低**：用户设置或预设里把 max_tokens 设得太小。
3. **SSE 断连/超时**：网络抖动导致流式连接提前结束。
4. **服务端重试/异常处理**：上游返回空/超时后重试，部分渠道会产生“前半段成功、后半段丢失”的现象。

## 2) 先做决策：补写还是重写？

优先补写（成本低、对齐更好）：
- 断在中后段，但前文质量/逻辑 OK
- 人称、口吻、设定没有漂移

考虑整章重写：
- 断点前已经出现明显跑题/设定冲突
- 结构崩坏（关键冲突没发生、情绪线断裂）
- 断点离章节开头很近（等于没写）

## 3) “补写”标准流程（稳定对齐）

### Step A：准备续写锚点

1. 取章节末尾 **200~500 字**作为锚点（要包含未完句子）。
2. 额外提供 3 条硬约束：
   - 当前场景地点
   - 在场角色（称谓）
   - 当前冲突/目标（一句话）

### Step B：续写提示词要点（直接可用）

把下面这段作为“用户指令”核心（可按题材调整）：

- 从锚点**后一两句**开始继续，不要复述已写内容。
- 先对齐：人称、时态、口吻、节奏，再推进剧情。
- 补齐该章节应有的结构：冲突升级 → 选择/动作 → 结果/悬念收尾。
- 严格遵守世界观与人物设定；不要引入新设定来硬解围。

### Step C：生成与拼接

1. 再次调用 `chapter_generate_stream`（或用局部重写接口），让模型输出“续写段”。
2. 拼接后做一次清理：
   - 删除重复句/重复段（常见于模型为“保险”而复述锚点内容）
   - 修正断句（把半句补完整）

## 4) max_tokens 怎么看、怎么调

### 4.1 “当前 max_tokens 是多少？”

它不是一个固定常量，取决于：
- 用户 Settings 里的 `max_tokens`（数据库字段）
- 若用户未设置，则回退到服务端 `default_max_tokens`
- 还会被具体模型的上限约束

最可靠的方式：直接通过 UI/接口读取当前用户 Settings。

### 4.2 调大能解决吗？

能缓解，但不要迷信：
- 调大 `max_tokens` 可以减少截断概率
- 但长篇更稳的是：控制单次目标字数 + 续写拼接

推荐组合：
- `target_word_count`：3000~6000
- `max_tokens`：设到模型允许的相对高值
- 断章时走“补写锚点”流程

