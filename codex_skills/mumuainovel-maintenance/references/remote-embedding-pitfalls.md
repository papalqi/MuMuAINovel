# 远端 Embedding 常见坑（ModelScope / OpenAI 兼容）

## 常见症状

### 1）HTTP 400 “inappropriate content”

- 服务端根据内容安全策略拦截了部分输入。
- 有时返回 JSON 错误，有时只返回纯文本。

推荐处理方式：
- 二分拆批 → 定位到具体哪一条文本触发拦截
- 只跳过那一条，并记录对应的 memory id（后续人工改写）
- 必要时手动重写该条记忆摘要，避免反复拦截

### 2）HTTP 429 限流

推荐处理方式：
- 指数退避 + 抖动重试
- 降低 batch_size

### 3）HTTP 200 但 `data=[]` / 数量不匹配

部分服务会返回 `200 OK`，但 `data` 数组为空（或长度小于输入）。
把它当作“该批次硬失败”，然后拆分直到定位到最小失败输入（通常是某一条文本或某个批大小触发了隐藏限制）。

## 建议持久化哪些信息（方便排查/前端展示）

每个分析任务建议记录：
- requested/added/skipped 数量
- 简短错误摘要（不要太长）
- embed_id + collection 名称

这样前端才能准确显示：“分析完成，但索引写入不完整（部分失败）”。
